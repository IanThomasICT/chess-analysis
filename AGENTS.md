# Agent Rules

## Documentation

Read `docs/README.md` first. It indexes all specs with related files so you can jump to the right doc efficiently.

## Commands

```bash
bun run dev          # Start dev server
bun run build        # Production build
bun run typecheck    # typegen + tsc + eslint (run this before committing)
bun run lint         # ESLint only
```

Always run `bun run typecheck` before considering work done. It runs all three checks in sequence: React Router type generation, TypeScript compiler, and ESLint.

## Strict Type Safety — No Exceptions

This codebase enforces **zero `any` types**. The ESLint config (`eslint.config.ts`) uses `typescript-eslint` strict type-checked mode with all `no-unsafe-*` rules set to error.

- Never use `any`. Use `unknown` and narrow with type guards, or define a proper interface.
- Never use `as any`. If you need a type assertion, assert to a specific type.
- Never use `// eslint-disable` to suppress type safety rules.
- Use `void` to explicitly discard promise return values when the result is intentionally unused (e.g. `void stdin.flush()`).

## Type Import Style

Route type imports **must** use top-level `import type` syntax:

```ts
// CORRECT — Rollup elides this entirely
import type { Route } from "./+types/home";

// WRONG — Rollup tries to resolve the module and the build fails
import { type Route } from "./+types/home";
```

This applies only to the `+types` virtual modules generated by React Router. For all other imports, either style is acceptable, but `separate-type-imports` is enforced by ESLint.

## Boolean Expressions

`strict-boolean-expressions` is enabled. Do not use truthy/falsy shortcuts on strings, numbers, or objects:

```ts
// WRONG
if (username) { ... }
if (data.error) { ... }

// CORRECT
if (username !== null && username !== "") { ... }
if (data.error !== undefined) { ... }
```

## Server-Only Files

Files suffixed `.server.ts` are never bundled into the client. All database access (`bun:sqlite`), Chess.com API calls, and Stockfish subprocess code must stay in `.server.ts` files. If you create new server-only logic, use this suffix.

## Database

- SQLite database is at `analysis.db` in the project root (gitignored).
- Schema is created on import in `app/lib/db.server.ts`.
- All query results use `as` assertions to typed interfaces — keep these interfaces in sync with the schema.
- The analysis table caches Stockfish results. Before spawning Stockfish, check `COUNT(*)` to avoid re-analyzing.

## Stockfish

- Binary path: `STOCKFISH_PATH` env var, or `$HOME/.local/bin/stockfish`, or `/usr/local/bin/stockfish`.
- Stockfish must be installed separately — it is not bundled with the project.
- The service uses `Bun.spawn` with `stdin: "pipe"` (returns `FileSink`, not `WritableStream`).
- All scores are from White's perspective (positive = White advantage).

## Chessground

- Use `@lichess-org/chessground` (v10 scoped package), not the old `chessground` package.
- Must be excluded from Vite's `optimizeDeps` in `vite.config.ts`.
- The `Key` type comes from `@lichess-org/chessground/types`.
- Board CSS is imported in `app/root.tsx` — do not import it elsewhere.

## Recharts Type Workarounds

Recharts' generic types are loose. When working with `Tooltip` or chart event handlers:
- `formatter` receives `number | undefined`, not `number`
- `labelFormatter` receives `React.ReactNode`, not `string`
- Chart `onClick` has no useful generic — define a local typed interface and cast at the boundary

## Move Indexing

Position index 0 = starting position (before any move). Move array index 0 = first move (White's first). `fens[i+1]` is the position after `moves[i]`.
